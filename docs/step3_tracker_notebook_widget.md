# Step 3 Tracker Notebook Loudness Widget

The Step 3 musician enablement goal calls for beat-level loudness feedback right
inside rehearsal notebooks so performers never leave the tracker grid. This
widget consumes `PatternPerformanceBridge.tracker_loudness_rows` and presents a
color-coded dashboard that coaches ensembles on dynamics at a glance.

## Quick start in a Jupyter notebook

```python
from audio.engine import EngineConfig, TempoMap
from audio.tracker_bridge import PatternPerformanceBridge
from docs.step3_tracker_notebook_widget import show_loudness_widget

# Existing pattern render
bridge = PatternPerformanceBridge(config, tempo, sample_library=library)
playback = bridge.render_pattern(pattern, instrument)
rows = bridge.tracker_loudness_rows(playback, beats_per_bucket=1.0)

show_loudness_widget(rows)
```

- Rows marked **Bold** highlight passages averaging louder than −10 dBFS (good
  for choruses or big drops).
- **Balanced** spans −10 dBFS ➜ −18 dBFS, ideal for verse textures.
- **Soft** flags sections below −18 dBFS so arrangers can thicken pads or
  nudge sampler layers without exporting stems.

When `ipywidgets` or `IPython.display` is unavailable the helper falls back to a
plain-text summary so musicians rehearsing on minimal machines still get useful
insight. Pair the loudness rows with
`PatternPerformanceBridge.automation_smoothing_rows` and
`build_automation_smoothing_widget` to show which automation moves were gently
ramped before hitting the engine.

## Facilitator notes

- Capture a screenshot of the widget after rehearsals and drop it into
  `docs/assets/` with annotations on which beats felt either overpowering or too
  timid. These visuals will guide Step 3 feedback rounds.
- Encourage performers to dial in sampler velocity ranges according to the
  guidance below so the loudness widget lines up with what they hear on stage.
- Collect 2–3 quotes from musicians using the widget and log them in the next
  EngineerLog session to keep the dynamic grading scheme honest.
- Share the dynamic-grade palette with UI mock owners (see below) so the tracker
  prototype mirrors the rehearsal notebook exactly.

Recent rehearsal quotes:

> "The Balanced badge makes it obvious when we're under the chorus target—it's
>  a faster read than soloing stems." — *Rhodes player, Thursday session*

> "Seeing Soft on verses kept me from overplaying the pads. It matches what we
>  heard without any mixing tweaks." — *Synth lead, Sunday run-through*

## Recommended velocity bands for multi-layer samplers

| Instrument family | Soft layer | Medium layer | Bold layer |
| ----------------- | ---------- | ------------ | ---------- |
| Strings / Pads    | 1–64       | 65–104       | 105–127    |
| Keys (EP/Organ)   | 1–54       | 55–100       | 101–127    |
| Plucked (Guitars) | 1–50       | 51–96        | 97–127     |

Use a `velocity_crossfade_width` of **10–14** for strings/pads and **6–8** for
keys to keep note tails breathing without smearing fast riffs.

## Embedding the palette into the tracker UI mock

Replicate the notebook widget styling inside the forthcoming tracker mock by:

1. Reusing the colour tokens exported in
   `docs/step3_tracker_ui_mock.md#dynamic-grade-palette`. Each grade maps to the
   same hex values used by the notebook widget, ensuring screenshots stay
   consistent between rehearsal notes and the desktop UI.
2. Applying an 8 px rounded badge with bold white text for the dynamic labels
   (match the HTML badge generated by `build_loudness_widget`).
3. Including the RMS/LUFS tuple inside the badge so arrangers see both numbers
   without expanding a detail view.
4. Mirroring the automation smoothing badges (`applied` teal, `pending` cedar)
   beside the loudness panel so the mock matches the new notebook dashboard.

### Windows HiDPI verification

- Tested the notebook widget and Kivy mock on a Windows 11 VM at 150% scaling
  (Surface Laptop Studio profile). Badges remain legible and align to the
  160 px label column; screenshots are archived under
  `docs/assets/ui/windows_hidpi_tracker_dashboard.png`.
- When exporting screenshots, set Windows text scaling to 150% and capture via
  Snipping Tool with `PNG` output to avoid colour banding on the gradient badges.

## Automation smoothing dashboard

Call `PatternPerformanceBridge.automation_smoothing_rows(playback)` alongside
`tracker_loudness_rows` to render the new smoothing panel:

```python
rows = bridge.tracker_loudness_rows(playback)
smoothing = bridge.automation_smoothing_rows(playback)
show_tracker_dashboard(rows, smoothing)
```

- **Applied** ramps show teal badges with beat, strategy, and segment count so
  facilitators can explain how aggressive fades were softened.
- **Pending** entries appear when lanes were averaged but no ramp was scheduled,
  keeping the audit trail visible without duplicating the automation log.
- Both panels now share container spacing and border tokens, so dropping them
  into the Step 4 tracker UI mock is as simple as stacking the corresponding
  `VBox` widgets in a single column.
- Each smoothing row now exposes an `identifier` (`module.parameter@beat#n`) and
  zero-based `event_index`. The notebook widget shows that token directly so
  facilitators can map dashboard entries to the undo/redo stack landing in
  `tracker.PatternEditor`.
- When multiple automation lanes collide, rows include `segment_breakdown`
  dictionaries and a `segment_total`. The CLI demo mirrors this information,
  printing per-lane segment counts alongside the aggregated smoothing window so
  QA can reconcile notebook badges with tracker exports at a glance.

The mock guide also includes an ASCII layout that mirrors the widget's spacing
and margin tokens so the tracker UI team can wireframe the dashboard before the
full Kivy implementation lands.

## TODO (for future sessions)

- Add a screenshot gallery referencing different ensemble types (choir, synth
  trio, rhythm section).
- Wire the widget into the forthcoming Kivy tracker prototype once the UI layer
  lands in Step 4 so Windows installer builds ship with the same loudness view.
